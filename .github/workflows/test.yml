name: Test package

on:
  push:
    branches:
      - "*"
  pull_request:
    branches:
      - "*"

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Initialise project
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            sudo apt-get update -y
            sudo apt-get install -y autoconf sed ghostscript poppler-utils perl-base
            sudo apt-get install -y `autoconf --trace 'PDFLBR_CHECK_PERL_MODULE:$2' | sed 's/,//g'`

      - name: Show Perl configuration
        run: |
          perl '-V:.*'

      - name: Configure project
        run: |
          ./bootstrap
          if ! ./configure; then
            cat ./config.log
            exit 1
          fi

      - name: Build project
        run: |
          make

  all-done:
    runs-on: ubuntu-latest

    needs: test

    steps:
      - name: All done
        run: |
          echo All done
